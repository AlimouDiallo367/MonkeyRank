<?php include 'header.phtml'; ?>

<h1>Leaderboard Monkeytype - Top Scores</h1>

<div id="error-message"></div>
<div id="success-message"></div>

<form id="score-form">
    <input type="text" id="pseudo" name="pseudo" placeholder="Pseudo (alphanumérique)" required pattern="[A-Za-z0-9]{1,50}" title="1 à 50 caractères alphanumériques" />
    <input type="number" step="0.01" id="wpm" name="wpm" placeholder="WPM (vitesse)" required min="0" />
    <input type="number" step="0.01" id="accuracy" name="accuracy" placeholder="Accuracy (%)" required min="0" max="100" />
    <input type="number" step="0.01" id="raw" name="raw" placeholder="Raw score" required min="0" />
    <input type="number" step="0.01" id="consistency" name="consistency" placeholder="Consistency (%)" required min="0" max="100" />
    <button type="submit">Ajouter Score</button>
</form>

<table id="leaderboard">
    <thead>
        <tr>
            <th>Pseudo</th>
            <th>WPM</th>
            <th>Accuracy (%)</th>
            <th>Raw</th>
            <th>Consistency (%)</th>
            <th>Date</th>
        </tr>
    </thead>
    <tbody>
	
    </tbody>
</table>

<script>
    async function loadScores() {
        try {
            const response = await fetch('http://localhost:4567/scores');
            if (!response.ok) throw new Error('Erreur réseau');
            const scores = await response.json();

            const tbody = document.querySelector('#leaderboard tbody');
            tbody.innerHTML = '';

            scores.forEach(score => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${score.pseudo}</td>
                    <td>${score.wpm.toFixed(2)}</td>
                    <td>${score.accuracy.toFixed(2)}</td>
                    <td>${score.raw.toFixed(2)}</td>
                    <td>${score.consistency.toFixed(2)}</td>
                    <td>${new Date(score.created_at).toLocaleString()}</td>
                `;
                tbody.appendChild(tr);
            });
        } catch (error) {
            document.getElementById('error-message').textContent = 'Erreur chargement des scores : ' + error.message;
            console.error(error);
        }
    }

    async function addScore(event) {
        event.preventDefault();
        const errorMsg = document.getElementById('error-message');
        const successMsg = document.getElementById('success-message');
        errorMsg.textContent = '';
        successMsg.textContent = '';

        const pseudo = document.getElementById('pseudo').value.trim();
        const wpm = parseFloat(document.getElementById('wpm').value);
        const accuracy = parseFloat(document.getElementById('accuracy').value);
        const raw = parseFloat(document.getElementById('raw').value);
        const consistency = parseFloat(document.getElementById('consistency').value);

        const scoreData = { pseudo, wpm, accuracy, raw, consistency };

        try {
            const response = await fetch('http://localhost:4567/scores', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(scoreData),
            });

            const result = await response.json();

            if (response.ok && result.success) {
                successMsg.textContent = 'Score ajouté avec succès !';
                loadScores();  // Recharge le leaderboard
                document.getElementById('score-form').reset();
            } else {
                errorMsg.textContent = result.errors ? result.errors.join(', ') : 'Erreur inconnue';
            }
        } catch (error) {
            errorMsg.textContent = 'Erreur lors de l\'ajout du score : ' + error.message;
        }
    }

    document.getElementById('score-form').addEventListener('submit', addScore);

    loadScores();
</script>

<?php include 'footer.phtml'; ?>

